<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubsy - Partial Vue App</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #fefefe; color: #333; }
        
        /* --- HEADER & NAV (IMPROVED) --- */
        .header { 
            background-color: #fff; 
            border-bottom: 1px solid #e0e0e0; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* The Nav container aligns items horizontally */
        nav {
            display: flex;
            justify-content: space-between; /* Pushes Logo left, Buttons right */
            align-items: center; /* Vertically centers them */
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
        }

        /* Logo Styling */
        .logo { 
            font-size: 15px; /* Fixed: Was 4px */
            font-weight: 800; 
            color: #0e0a07; 
            text-decoration: none; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 100px; /* Set a proper height for the image */
            width: auto;
        }

        /* Add this to your CSS to style the disabled cart button */
        .cart-btn:disabled {
            background-color: #e0e0e0; /* Grey background */
            color: #999; /* Grey text */
            cursor: not-allowed; /* Shows a 'no' symbol on hover */
            box-shadow: none;
        }
        
        /* Optional: Hide the red counter badge when cart is empty/disabled */
        .cart-btn:disabled .cart-count {
            display: none;
        }
        
        /* Group for the buttons */
        .nav-links {
            display: flex;
            align-items: center;
            gap: 15px; /* Spacing between Lessons and Cart */
        }

        .nav-btn { 
            padding: 10px 15px; 
            background: none; 
            border: none; 
            font-size: 16px; 
            cursor: pointer; 
            color: #555; 
            transition: color 0.2s;
        }

        .nav-btn:hover { color: #000; }
        .nav-btn.active { font-weight: bold; color: #0e0a07; }

        .cart-btn { 
            position: relative; 
            background-color: #f0c419; 
            color: #0e0a07; 
            font-weight: bold; 
            border-radius: 8px; 
            padding: 10px 20px;
            transition: background 0.2s;
        }
        .cart-btn:hover { background-color: #eebb10; }

        .cart-count { 
            background: #c0392b; 
            color: white; 
            padding: 2px 6px; 
            border-radius: 50%; 
            font-size: 12px; 
            margin-left: 5px; 
            vertical-align: middle;
        }

        /* --- CONTENT STYLES --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        
        /* Search & Sort */
        .search-bar { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .sort-select { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: white; cursor: pointer; }

        /* Grid */
        .lessons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .lesson-card { border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; background: white; transition: transform 0.2s; }
        .lesson-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .lesson-image { width: 100%; height: 200px; object-fit: cover; background: #eee; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .lesson-title { font-size: 18px; font-weight: 700; }
        .lesson-info { font-size: 14px; color: #666; display: flex; justify-content: space-between; }
        
        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: auto; transition: 0.2s; }
        .btn-add { background-color: #0e0a07; color: white; }
        .btn-add:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-add:hover:not(:disabled) { background-color: #333; }
        
        /* Cart Page */
        .cart-item { display: flex; gap: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; align-items: center; background: white; }
        .cart-img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .cart-details { flex: 1; }
        .btn-remove { background: #c0392b; color: white; width: auto; padding: 8px 16px; }
        .btn-remove:hover { background: #a93226; }

        /* Checkout */
        .checkout-box { background: #f9f9f9; padding: 30px; border-radius: 12px; margin-top: 40px; border: 1px solid #eee; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .error { color: #c0392b; font-size: 12px; margin-top: 5px; }
        .btn-checkout { background-color: #2ecc71; color: white; font-size: 18px; }
        .btn-checkout:disabled { background-color: #ccc; cursor: not-allowed; }

        .state-msg { text-align: center; font-size: 18px; color: #777; margin-top: 50px; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <nav>
            <a href="#" class="logo" @click.prevent="currentView = 'lessons'">
               <img :src="getImageUrl('hubsy.png')" alt="Hubsy Logo" class="logo-img">
            </a>

            <div class="nav-links">
                <button class="nav-btn" :class="{active: currentView === 'lessons'}" @click="currentView = 'lessons'">
                    Lessons
                </button>
                <button class="nav-btn cart-btn" :disabled="cart.length === 0" :class="{active: currentView === 'cart'}" @click="currentView = 'cart'">
                    Cart <span class="cart-count">{{ cart.length }}</span>
                </button>
            </div>
        </nav>
    </header>

    <div v-if="currentView === 'lessons'" class="container">
        <div class="search-bar">
            <input 
                v-model="searchQuery" 
                @input="performSearch" 
                class="search-input" 
                placeholder="Search lessons..."
            >
            
            <select v-model="sortAttribute" class="sort-select">
                <option value="title">Sort by Subject</option>
                <option value="location">Sort by Location</option>
                <option value="price">Sort by Price</option>
                <option value="spaces">Sort by Availability</option>
            </select>
            <button class="sort-select" @click="toggleSortOrder">
                {{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }}
            </button>
        </div>

        <div v-if="loading" class="state-msg">Loading lessons...</div>
        <div v-else class="lessons-grid">
            <div v-for="lesson in sortedLessons" :key="lesson._id" class="lesson-card">
                <img :src="getImageUrl(lesson.image)" class="lesson-image" alt="Lesson Image">
                <div class="card-body">
                    <h3 class="lesson-title">{{ lesson.title }}</h3>
                    <p>üìç {{ lesson.location }}</p>
                    <div class="lesson-info">
                        <span>üí∞ ${{ lesson.price }}</span>
                        <span>üéü {{ lesson.spaces > 0 ? lesson.spaces : 0 }} spaces left</span>
                    </div>
                    <button 
                        class="btn btn-add" 
                        @click="addToCart(lesson)"
                        :disabled="lesson.spaces <= 0"
                    >
                        {{ getButtonText(lesson) }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentView === 'cart'" class="container">
        <h2>Shopping Cart</h2>
        
        <div v-if="cart.length === 0" class="state-msg">
            Your cart is empty. <br>
            <br>
            <button class="nav-btn" style="background:#ddd; border-radius:6px;" @click="currentView = 'lessons'">Back to Lessons</button>
        </div>

        <div v-else>
            <div v-for="(item, index) in cart" :key="index" class="cart-item">
                <img :src="getImageUrl(item.image)" class="cart-img">
                <div class="cart-details">
                    <h3>{{ item.title }}</h3>
                    <p>${{ item.price }}</p>
                </div>
                <button class="btn btn-remove" @click="removeFromCart(index, item)">Remove</button>
            </div>

            <div class="checkout-box">
                <h3>Checkout</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input v-model="checkout.name" class="form-input" type="text" placeholder="Enter your name">
                    <p v-if="!isNameValid && checkout.name" class="error">Name must be letters only</p>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input v-model="checkout.phone" class="form-input" type="tel" placeholder="Enter phone number">
                    <p v-if="!isPhoneValid && checkout.phone" class="error">Phone must be numbers only</p>
                </div>
                <button 
                    class="btn btn-checkout" 
                    :disabled="!isFormValid"
                    @click="submitOrder"
                >
                    {{ orderStatus || 'Checkout' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const lessons = ref([]);
            const cart = ref([]);
            const currentView = ref('lessons'); 
            
            // Search & Sort
            const searchQuery = ref('');
            const sortAttribute = ref('title');
            const sortOrder = ref('asc');
            
            // Loading
            const loading = ref(true);
            
            // Checkout
            const checkout = ref({ name: '', phone: '' });
            const orderStatus = ref('');

            // --- CONFIGURATION ---
            const API_URL = "https://hubsy-2-0.onrender.com"; 

            // --- METHODS ---
            
            // 1. Fetch Lessons (Default)
            const fetchLessons = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/lessons`);
                    lessons.value = await res.json();
                } catch (err) {
                    console.error("Fetch error:", err);
                } finally {
                    loading.value = false;
                }
            };

            // 2. Perform Search (Backend Search)
            const performSearch = async () => {
                if (!searchQuery.value) {
                    return fetchLessons(); 
                }
                try {
                    const res = await fetch(`${API_URL}/api/search?q=${searchQuery.value}`);
                    lessons.value = await res.json();
                } catch (err) {
                    console.error("Search error:", err);
                }
            };

            const getImageUrl = (img) => {
                if (!img) return 'https://placehold.co/600x400';
                return `${API_URL}/images/${img}`;
            };

            // 3. Cart Logic
            const addToCart = (lesson) => {
                if (lesson.spaces > 0) {
                    cart.value.push(lesson);
                    lesson.spaces--; 
                }
            };

            const removeFromCart = (index, itemToRemove) => {
                cart.value.splice(index, 1);
                const lesson = lessons.value.find(l => l._id === itemToRemove._id);
                if (lesson) {
                    lesson.spaces++;
                }
            };

            const getButtonText = (lesson) => {
                if (lesson.spaces <= 0) return 'Sold Out';
                return 'Add to Cart';
            };

            // 4. SORT FUNCTIONALITY
            const sortedLessons = computed(() => {
                let temp = [...lessons.value]; 

                return temp.sort((a, b) => {
                    let valA = a[sortAttribute.value];
                    let valB = b[sortAttribute.value];
                    
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return sortOrder.value === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder.value === 'asc' ? 1 : -1;
                    return 0;
                });
            });

            const toggleSortOrder = () => {
                sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
            };

            // 5. Checkout Validation
            const isNameValid = computed(() => /^[a-zA-Z\s]+$/.test(checkout.value.name));
            const isPhoneValid = computed(() => /^[0-9]+$/.test(checkout.value.phone));
            const isFormValid = computed(() => isNameValid.value && isPhoneValid.value && cart.value.length > 0);

            // 6. Submit Order
            const submitOrder = async () => {
                orderStatus.value = "Processing...";
                
                const orderData = {
                    name: checkout.value.name,
                    phone: checkout.value.phone,
                    lessonIds: cart.value.map(i => i._id),
                    spacesBooked: cart.value.length,
                };

                try {
                    const res = await fetch(`${API_URL}/api/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    if (res.ok) {
                        // Update Spaces
                        const updates = {};
                        for (const item of cart.value) {
                            if (!updates[item._id]) {
                                updates[item._id] = { 
                                    spaces: item.spaces,
                                    id: item._id 
                                };
                            }
                        }

                        for (const key in updates) {
                             const item = updates[key];
                             await fetch(`${API_URL}/api/lessons/${item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ spaces: item.spaces }) 
                             });
                        }

                        alert("Order Submitted Successfully!");
                        cart.value = [];
                        checkout.value = { name: '', phone: '' };
                        orderStatus.value = '';
                        currentView.value = 'lessons';
                        fetchLessons(); 
                    } else {
                        orderStatus.value = "Failed. Try again.";
                    }
                } catch (e) {
                    console.error(e);
                    orderStatus.value = "Error.";
                }
            };

            onMounted(() => {
                fetchLessons();
            });

            return {
                currentView, lessons, cart, loading,
                searchQuery, sortAttribute, sortOrder,
                sortedLessons, toggleSortOrder, performSearch,
                getImageUrl, addToCart, removeFromCart, getButtonText,
                checkout, isNameValid, isPhoneValid, isFormValid, submitOrder, orderStatus
            };
        }
    }).mount('#app');
</script>

</body>
</html>